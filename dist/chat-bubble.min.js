class MessageQueue{constructor(e={}){this._config={delayPerMessage:e.delayPerMessage||400,onMessageProcess:e.onMessageProcess||(()=>{}),onPause:e.onPause||(()=>{}),onQueueComplete:e.onQueueComplete||(()=>{}),autoplay:e.autoplay??!0},this._queue=[],this._isPaused=!this._config.autoplay,this._isSkipDelayEnabled=!1,this._currentTimeout=null,this._isRunning=!1}get isRunning(){return this._isRunning&&!this._isPaused}async _start(){this._isRunning||(this._isRunning=!0,this._processMessages())}async _processMessages(){if(!this._isPaused){for(;this._queue.length>0&&!this._isPaused;){const e=this._queue.shift();if(await this._processMessage(e),e.pauseAfter)return void this.pause()}this._isRunning=this._queue.length>0,this._isRunning||this._isPaused||this._config.onQueueComplete?.()}}async _processMessage(e){return new Promise((s=>{this._config.onMessageProcess?.(e);const t=e.delayPerMessage??this._config.delayPerMessage;this._isSkipDelayEnabled||t<=0?s():this._currentTimeout=setTimeout((()=>{this._currentTimeout=null,s()}),t)}))}_clearCurrentTimeout(){this._currentTimeout&&(clearTimeout(this._currentTimeout),this._currentTimeout=null)}add(e){this._queue.push(e),this._isRunning||this._isPaused||this._start()}cancel(){this._queue=[],this._isRunning=!1,this._isPaused=!1,this._isSkipDelayEnabled=!1,this._clearCurrentTimeout()}skipDelay(){this._isSkipDelayEnabled=!0,this._clearCurrentTimeout(),this._isRunning&&this._processMessages()}pause(){this._isPaused=!0,this._clearCurrentTimeout(),this._config.onPause?.()}resume(){this._isPaused&&(this._isPaused=!1,this._processMessages())}}class TextFormatterService{formatText(e){let s=e.replace(/\n/g,"<br>");return s=s.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),s=s.replace(/\*(.*?)\*/g,"<em>$1</em>"),s}}class TimestampFormatterService{formatTimestamp(e,s="time"){const t=new Date(e);switch(s){case"datetime":return t.toLocaleString([],{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});case"relative":return this._getRelativeTime(t);default:return t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}_getRelativeTime(e){const s=new Date,t=Math.round((s-e)/1e3);if(t<60)return"just now";if(t<3600){return`${Math.floor(t/60)} min ago`}if(t<86400){const e=Math.floor(t/3600);return`${e} hour${e>1?"s":""} ago`}return e.toLocaleDateString()}}class ChatBubble{constructor(e={}){this.version="2.5.0";const s=new TextFormatterService,t=new TimestampFormatterService;this._config={...e,users:e.users||[],autoplay:e.autoplay??!0,onPause:e.onPause,timestampFormat:e.timestampFormat||"time",delayPerMessage:e.delayPerMessage||400,maxVisibleMessages:e.maxVisibleMessages||50,characterMode:e.characterMode||!1,hideBubbleImages:e.hideBubbleImages||!1,textFormatter:e.textFormatter||s,timestampFormatter:e.timestampFormatter||t},this._styles={container:"chat-bubble-container",messageList:"chat-message-list",bubble:"chat-bubble",text:"chat-text",userBubble:"user",botBubble:"bot",timestamp:"chat-bubble-timestamp",senderName:"sender-name",imageContainer:"chat-bubble-image-container"},this._animations={enabled:!1!==e.animations?.enabled,userClass:"animate__animated animate__fadeInRight",botClass:"animate__animated animate__fadeInLeft"},this._container=e.container||document.body,this._messages=(e.initialMessages||[]).map((e=>({...e,state:e.state||"default"}))),this._messageQueue=new MessageQueue({delayPerMessage:this._config.delayPerMessage,autoplay:this._config.autoplay,onMessageProcess:e=>this._renderNewMessage(e),onPause:()=>this._config.onPause?.(),onQueueComplete:()=>this._config.onQueueComplete?.()}),this._init(),this._config.characterMode&&this._createCharacterContainers(),this._messages.forEach((e=>this._messageQueue.add(e)))}_init(){this._chatContainer=document.createElement("div"),this._chatContainer.className=this._styles.container,this._container.appendChild(this._chatContainer),this._messageList=document.createElement("div"),this._messageList.className=this._styles.messageList,this._chatContainer.appendChild(this._messageList)}_getUser(e){return this._config.users.find((s=>s.id===e))}_getAnimationClass(e){return this._animations.enabled?"user"===e?this._animations.userClass:this._animations.botClass:""}_createImageContainer(e,s){const t=this._getUser(e);if(!t)return"";const a=t.images?t.images[s]||t.images.default:null;return a?`\n  <div class="${this._styles.imageContainer}">\n  <img src="${a}" alt="${t.name} avatar" />\n  </div>\n  `:""}_createCharacterContainers(){this._botCharacterContainer=document.createElement("div"),this._botCharacterContainer.className="character-container bot-character",this._userCharacterContainer=document.createElement("div"),this._userCharacterContainer.className="character-container user-character",this._chatContainer.insertBefore(this._botCharacterContainer,this._messageList),this._chatContainer.appendChild(this._userCharacterContainer)}_updateCharacterImages(e){if(!this._config.characterMode)return;const s=this._getUser(e.userId),t=s.images[e.state]||s.images.default;("user"===s.type?this._userCharacterContainer:this._botCharacterContainer).innerHTML=`<img src="${t}" alt="${s.name} character">`}_renderNewMessage(e){this._updateCharacterImages(e);const s=this._createMessageBubble(e);this._messageList.appendChild(s),this._messageList.children.length>this._config.maxVisibleMessages&&this._messageList.removeChild(this._messageList.firstChild);const t=this._config.characterMode?this._messageList:this._chatContainer;t.scrollTo({top:t.scrollHeight,behavior:"smooth"}),this._config.onMessageAdded?.(s)}_createMessageBubble(e){const s=this._getUser(e.userId);if(!s)throw new Error(`User with userId "${e.userId}" not found.`);const t=document.createElement("div");t.className=`${this._styles.bubble} ${"user"===s.type?this._styles.userBubble:this._styles.botBubble} ${this._getAnimationClass(s.type)}`;const a=this._config.hideBubbleImages?"":this._createImageContainer(e.userId,e.state),i=e.timestamp?`<div class="${this._styles.timestamp}">${this._config.timestampFormatter.formatTimestamp(e.timestamp,this._config.timestampFormat)}</div>`:"",n=this._config.textFormatter.formatText(e.text);return t.innerHTML=`${a}\n      <div class="${this._styles.senderName}">${s.name}</div>\n      <div class="${this._styles.text}">${n}</div>\n      ${i}`,t}addMessage(e){this._messages.push(e),this._messageQueue.add(e)}cancelMessages(){this._messageQueue.cancel(),this._messageList.innerHTML=""}replayMessages(){this.cancelMessages(),this._messageQueue._defaultDelay=this._config.delayPerMessage,this._messages.forEach((e=>this._messageQueue.add(e)))}skipDelay(){this._messageQueue.skipDelay()}pauseMessages(){this._messageQueue.pause()}resumeMessages(){this._messageQueue.resume()}}